@page "/"
@using System.Linq
@using Microsoft.Extensions.Options
@using Microsoft.JSInterop
@inject BrickBreaker.WebClient.Services.ApiClient Api
@inject IJSRuntime JS
@inject IOptions<TurnstileClientOptions> Turnstile
@implements IDisposable

<PageTitle>BrickBreaker Web</PageTitle>

<section class="intro">
    <h1>BrickBreaker – Web Edition</h1>
    <p>Use ←/→ or A/D to move, ↑/W to launch, and P to pause. Space restarts after a game over.</p>
</section>

@if (!_isLoggedIn)
{
    <section class="auth-grid">
        <div class="card">
            <h3>Login</h3>
            <label>Username</label>
            <input @bind="_loginUsername" @bind:event="oninput" />
            <label>Password</label>
            <input type="password" @bind="_loginPassword" @bind:event="oninput" />
            @if (_turnstileEnabled)
            {
                <div class="turnstile-slot" id="login-turnstile"></div>
            }
            <button @onclick="LoginAsync" disabled="@_isBusy">Login</button>
        </div>
        <div class="card">
            <h3>Register</h3>
            <label>Username</label>
            <input @bind="_registerUsername" @bind:event="oninput" />
            <label>Password</label>
            <input type="password" @bind="_registerPassword" @bind:event="oninput" />
            @if (_turnstileEnabled)
            {
                <div class="turnstile-slot" id="register-turnstile"></div>
            }
            <button @onclick="RegisterAsync" disabled="@_isBusy">Create Account</button>
        </div>
    </section>

    @if (!string.IsNullOrWhiteSpace(_statusMessage))
    {
        <div class="status-banner">
            @_statusMessage
        </div>
    }
}
else
{
    <section class="auth-grid">
        <div class="card">
            <h3>Player</h3>
            <p>Signed in as <strong>@_currentUser</strong></p>
            <p>Best score: @(_bestEntry?.Score.ToString() ?? "—")</p>
            <button @onclick="Logout" disabled="@_isBusy">Logout</button>
        </div>
    </section>
}

<section class="leaderboard">
    <h3>Leaderboard</h3>
    @if (_leaderboard.Count == 0)
    {
        <p>No scores yet.</p>
    }
    else
    {
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Player</th>
                    <th>Score</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                @for (var i = 0; i < _leaderboard.Count; i++)
                {
                    var entry = _leaderboard[i];
                    <tr>
                        <td>@(i + 1)</td>
                        <td>@entry.Username</td>
                        <td>@entry.Score</td>
                        <td>@entry.At.ToLocalTime().ToString("g")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
</section>

<section class="game-section">
    <GameCanvas OnGameFinished="HandleGameFinished" />
</section>

@code {
    private const string LoginTurnstileElementId = "login-turnstile";
    private const string RegisterTurnstileElementId = "register-turnstile";

    private string _statusMessage = string.Empty;
    private bool _isBusy;
    private bool _isLoggedIn;
    private string _currentUser = string.Empty;
    private string _loginUsername = string.Empty;
    private string _loginPassword = string.Empty;
    private string _registerUsername = string.Empty;
    private string _registerPassword = string.Empty;
    private bool _turnstileEnabled;
    private string? _turnstileSiteKey;
    private string? _loginTurnstileToken;
    private string? _registerTurnstileToken;
    private DotNetObjectReference<Home>? _turnstileRef;
    private List<LeaderboardEntry> _leaderboard = new();
    private LeaderboardEntry? _bestEntry;

    protected override async Task OnInitializedAsync()
    {
        _turnstileEnabled = Turnstile.Value.IsConfigured;
        _turnstileSiteKey = Turnstile.Value.SiteKey;
        if (_turnstileEnabled)
        {
            _turnstileRef = DotNetObjectReference.Create(this);
        }
        await RefreshLeaderboardAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _turnstileEnabled)
        {
            await RenderTurnstileAsync(LoginTurnstileElementId, "login");
            await RenderTurnstileAsync(RegisterTurnstileElementId, "register");
        }
    }

    private async Task LoginAsync()
    {
        if (_isBusy)
        {
            return;
        }

        _isBusy = true;
        _statusMessage = string.Empty;
        var username = (_loginUsername ?? string.Empty).Trim();
        var password = _loginPassword ?? string.Empty;
        if (_turnstileEnabled && string.IsNullOrWhiteSpace(_loginTurnstileToken))
        {
            _statusMessage = "Complete the CAPTCHA to continue.";
            _isBusy = false;
            return;
        }

        var result = await Api.LoginAsync(username, password, _loginTurnstileToken);
        if (result.Success && result.Value is not null)
        {
            _isLoggedIn = true;
            _currentUser = result.Value.Username;
            _loginPassword = string.Empty;
            await LoadBestAsync();
            _statusMessage = "Signed in.";
        }
        else
        {
            Api.ClearAuthentication();
            _isLoggedIn = false;
            _currentUser = string.Empty;
            _statusMessage = result.Error ?? "Login failed.";
        }
        if (_turnstileEnabled)
        {
            _loginTurnstileToken = null;
            await ResetTurnstileAsync(LoginTurnstileElementId);
        }
        _isBusy = false;
    }

    private async Task RegisterAsync()
    {
        if (_isBusy)
        {
            return;
        }

        _isBusy = true;
        _statusMessage = string.Empty;
        var username = (_registerUsername ?? string.Empty).Trim();
        if (_turnstileEnabled && string.IsNullOrWhiteSpace(_registerTurnstileToken))
        {
            _statusMessage = "Complete the CAPTCHA to continue.";
            _isBusy = false;
            return;
        }

        var result = await Api.RegisterAsync(username, _registerPassword ?? string.Empty, _registerTurnstileToken);
        _statusMessage = result.Success ? "Registration successful." : result.Error ?? "Registration failed.";
        if (result.Success)
        {
            _loginUsername = _registerUsername ?? string.Empty;
            _registerUsername = string.Empty;
            _registerPassword = string.Empty;
        }
        if (_turnstileEnabled)
        {
            _registerTurnstileToken = null;
            await ResetTurnstileAsync(RegisterTurnstileElementId);
        }
        _isBusy = false;
    }

    private void Logout()
    {
        _isLoggedIn = false;
        _currentUser = string.Empty;
        _bestEntry = null;
        Api.ClearAuthentication();
        _statusMessage = "Signed out.";
    }

    private async Task RefreshLeaderboardAsync()
    {
        var result = await Api.GetLeaderboardAsync(10);
        if (result.Success && result.Value is not null)
        {
            _leaderboard = result.Value.ToList();
        }
        else
        {
            _leaderboard.Clear();
            if (!string.IsNullOrWhiteSpace(result.Error))
            {
                _statusMessage = result.Error;
            }
        }
    }

    private async Task LoadBestAsync()
    {
        if (!_isLoggedIn)
        {
            _bestEntry = null;
            return;
        }

        var result = await Api.GetBestAsync(_currentUser);
        if (result.Success)
        {
            _bestEntry = result.Value;
        }
    }

    private async Task HandleGameFinished(int score)
    {
        if (!_isLoggedIn || string.IsNullOrWhiteSpace(_currentUser))
        {
            _statusMessage = "Score not submitted (not logged in).";
            return;
        }

        var result = await Api.SubmitScoreAsync(_currentUser, score);
        _statusMessage = result.Success ? $"Score {score} submitted." : result.Error ?? "Score submission failed.";
        if (result.Success)
        {
            await RefreshLeaderboardAsync();
            await LoadBestAsync();
        }
    }

    private async Task RenderTurnstileAsync(string elementId, string action)
    {
        if (!_turnstileEnabled || string.IsNullOrWhiteSpace(_turnstileSiteKey) || _turnstileRef is null)
        {
            return;
        }

        try
        {
            await JS.InvokeVoidAsync("turnstileInterop.render", elementId, _turnstileSiteKey, _turnstileRef, nameof(HandleTurnstileTokenAsync), action);
        }
        catch
        {
            // If the widget fails to render, keep the app functional without CAPTCHA.
            _turnstileEnabled = false;
        }
    }

    private async Task ResetTurnstileAsync(string elementId)
    {
        if (!_turnstileEnabled)
        {
            return;
        }

        await JS.InvokeVoidAsync("turnstileInterop.reset", elementId);
    }

    private async Task ResetAllTurnstilesAsync()
    {
        if (!_turnstileEnabled)
        {
            return;
        }

        _loginTurnstileToken = null;
        _registerTurnstileToken = null;
        await ResetTurnstileAsync(LoginTurnstileElementId);
        await ResetTurnstileAsync(RegisterTurnstileElementId);
    }

    [JSInvokable]
    public Task HandleTurnstileTokenAsync(string elementId, string? token)
    {
        var normalized = string.IsNullOrWhiteSpace(token) ? null : token;
        if (elementId == LoginTurnstileElementId)
        {
            _loginTurnstileToken = normalized;
        }
        else if (elementId == RegisterTurnstileElementId)
        {
            _registerTurnstileToken = normalized;
        }

        return Task.CompletedTask;
    }

    public void Dispose()
    {
        _turnstileRef?.Dispose();
    }
}
