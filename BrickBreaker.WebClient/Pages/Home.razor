@page "/"
@using System.Linq
@using Microsoft.Extensions.Options
@using Microsoft.JSInterop
@using BrickBreaker.WebClient.Components
@inject BrickBreaker.WebClient.Services.ApiClient Api
@inject IJSRuntime JS
@inject IOptions<TurnstileClientOptions> Turnstile
@implements IDisposable

<PageTitle>BrickBreaker Web</PageTitle>

<section class="intro">
    <h1>BrickBreaker – Web Edition</h1>
    <p>Use ←/→ or A/D to move, ↑/W to launch, Space to pause, and Enter to restart after a game over.</p>
</section>

<main class="bb-shell">
    <section class="bb-layout">
        <section class="bb-main">
            <div class="panel panel--game">
                <header class="panel__header">
                    <h2>Arcade</h2>
                    <span class="panel__hint">@GameStatusHint</span>
                </header>

                <GameCanvas OnGameFinished="HandleGameFinished"
                            OnStateChanged="UpdateGameState" />

                <footer class="panel__footer panel__footer--status">
                    <div>Score: @_currentScore</div>
                    <div>Level: @_currentLevel</div>
                    <div>Lives: @_currentLives</div>
                </footer>
            </div>
        </section>

        <aside class="bb-sidebar">
            <section class="panel panel--account">
                <header class="panel__header">
                    <h2>@(_isLoggedIn ? "Player" : "Account")</h2>
                    <span class="panel__hint">@(_isLoggedIn ? "Manage your profile and logout" : "Sign in to track runs")</span>
                </header>
                @if (_isAccountLoading)
                {
                    <div class="panel__loading">
                        <div class="loading-spinner" role="status" aria-live="polite"></div>
                        <p>Warming up the API...</p>
                    </div>
                }

                @if (!_isLoggedIn)
                {
                    <div class="auth-grid">
                        <div class="card auth-card @( _showLoginPanel ? "expanded" : string.Empty)">
                            <button type="button"
                                    class="card-toggle"
                                    aria-expanded="@_showLoginPanel"
                                    @onclick="() => TogglePanel(AuthPanel.Login)">
                                <span>Login</span>
                                <span class="chevron @( _showLoginPanel ? "open" : string.Empty)"></span>
                            </button>
                            <form class="auth-panel @( _showLoginPanel ? "show" : "hide")"
                                  aria-hidden="@(!_showLoginPanel)"
                                  @onsubmit="HandleLoginSubmit"
                                  @onsubmit:preventDefault="true">
                                <label>Username</label>
                                <input @bind="_loginUsername" @bind:event="oninput" autocomplete="username" />
                                <label>Password</label>
                                <input type="password" @bind="_loginPassword" @bind:event="oninput" autocomplete="current-password" />
                                @if (_turnstileEnabled)
                                {
                                    <div class="turnstile-slot" id="login-turnstile"></div>
                                }
                                <button type="submit" class="primary-action" disabled="@_isBusy">Login</button>
                            </form>
                        </div>
                        <div class="card auth-card @( _showRegisterPanel ? "expanded" : string.Empty)">
                            <button type="button"
                                    class="card-toggle"
                                    aria-expanded="@_showRegisterPanel"
                                    @onclick="() => TogglePanel(AuthPanel.Register)">
                                <span>Create Account</span>
                                <span class="chevron @( _showRegisterPanel ? "open" : string.Empty)"></span>
                            </button>
                            <form class="auth-panel @( _showRegisterPanel ? "show" : "hide")"
                                  aria-hidden="@(!_showRegisterPanel)"
                                  @onsubmit="HandleRegisterSubmit"
                                  @onsubmit:preventDefault="true">
                                <label>Username</label>
                                <input @bind="_registerUsername" @bind:event="oninput" autocomplete="username" />
                                <label>Password</label>
                                <input type="password" @bind="_registerPassword" @bind:event="oninput" autocomplete="new-password" />
                                @if (_turnstileEnabled)
                                {
                                    <div class="turnstile-slot" id="register-turnstile"></div>
                                }
                                <button type="submit" class="primary-action" disabled="@_isBusy">Create Account</button>
                            </form>
                        </div>
                    </div>
                }
                else
                {
                    <div class="card profile-card">
                        <h3>Signed in as</h3>
                        <p class="profile-card__user">@_currentUser</p>
                        <p class="profile-card__stat">Best score: @(_bestEntry?.Score.ToString() ?? "—")</p>
                        <button class="primary-action" @onclick="Logout" disabled="@_isBusy">Logout</button>
                    </div>
                }

                @if (!string.IsNullOrWhiteSpace(_statusMessage))
                {
                    <div class="status-banner">
                        @_statusMessage
                    </div>
                }
            </section>

            <section class="panel panel--leaderboard">
                <header class="panel__header">
                    <h2>Leaderboard</h2>
                </header>
                @if (_isLeaderboardLoading)
                {
                    <div class="panel__loading">
                        <div class="loading-spinner" role="status" aria-live="polite"></div>
                        <p>Fetching latest scores...</p>
                    </div>
                }

                <div class="leaderboard-body">
                    @if (_leaderboard.Count == 0)
                    {
                        <p class="muted">No scores yet. Be the first.</p>
                    }
                    else
                    {
                        <table class="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Player</th>
                                    <th>Score</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (var i = 0; i < _leaderboard.Count; i++)
                                {
                                    var entry = _leaderboard[i];
                                    <tr>
                                        <td>@(i + 1)</td>
                                        <td>@entry.Username</td>
                                        <td>@entry.Score</td>
                                        <td>@entry.At.ToLocalTime().ToString("yyyy-MM-dd, HH:mm")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>
            </section>
        </aside>
    </section>
</main>

@code {
    private const string LoginTurnstileElementId = "login-turnstile";
    private const string RegisterTurnstileElementId = "register-turnstile";

    private string _statusMessage = string.Empty;
    private bool _isBusy;
    private bool _isLoggedIn;
    private string _currentUser = string.Empty;
    private string _loginUsername = string.Empty;
    private string _loginPassword = string.Empty;
    private string _registerUsername = string.Empty;
    private string _registerPassword = string.Empty;
    private bool _turnstileEnabled;
    private string? _turnstileSiteKey;
    private string? _loginTurnstileToken;
    private string? _registerTurnstileToken;
    private bool _turnstileRenderPending;
    private bool _showLoginPanel = true;
    private bool _showRegisterPanel;
    private int _currentScore;
    private int _currentLevel = 1;
    private int _currentLives = 1;
    private bool _gamePaused;
    private bool _gameOver;
    private bool _ballReady = true;
    private DotNetObjectReference<Home>? _turnstileRef;
    private List<LeaderboardEntry> _leaderboard = new();
    private LeaderboardEntry? _bestEntry;
    private bool _isAccountLoading = true;
    private bool _isLeaderboardLoading = true;
    private enum AuthPanel
    {
        Login,
        Register
    }

    protected override async Task OnInitializedAsync()
    {
        _turnstileEnabled = Turnstile.Value.IsConfigured;
        _turnstileSiteKey = Turnstile.Value.SiteKey;
        if (_turnstileEnabled)
        {
            _turnstileRef = DotNetObjectReference.Create(this);
            _turnstileRenderPending = true;
        }
        await RefreshLeaderboardAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_turnstileEnabled && _turnstileRenderPending)
        {
            _turnstileRenderPending = false;
            await RenderTurnstileAsync(LoginTurnstileElementId, "login");
            await RenderTurnstileAsync(RegisterTurnstileElementId, "register");
        }
    }

    private Task HandleLoginSubmit() => LoginAsync();

    private async Task LoginAsync()
    {
        if (_isBusy)
        {
            return;
        }

        _isBusy = true;
        _statusMessage = string.Empty;
        var username = (_loginUsername ?? string.Empty).Trim();
        var password = _loginPassword ?? string.Empty;
        if (_turnstileEnabled && string.IsNullOrWhiteSpace(_loginTurnstileToken))
        {
            _statusMessage = "Complete the CAPTCHA to continue.";
            _isBusy = false;
            return;
        }

        var result = await Api.LoginAsync(username, password, _loginTurnstileToken);
        if (result.Success && result.Value is not null)
        {
            _isLoggedIn = true;
            _currentUser = result.Value.Username;
            _loginPassword = string.Empty;
            await LoadBestAsync();
            _statusMessage = "Signed in.";
        }
        else
        {
            Api.ClearAuthentication();
            _isLoggedIn = false;
            _currentUser = string.Empty;
            _statusMessage = result.Error ?? "Login failed.";
        }
        if (_turnstileEnabled)
        {
            _loginTurnstileToken = null;
            await ResetTurnstileAsync(LoginTurnstileElementId);
        }
        _isBusy = false;
    }

    private Task HandleRegisterSubmit() => RegisterAsync();

    private async Task RegisterAsync()
    {
        if (_isBusy)
        {
            return;
        }

        _isBusy = true;
        _statusMessage = string.Empty;
        var username = (_registerUsername ?? string.Empty).Trim();
        var password = _registerPassword ?? string.Empty;
        if (string.IsNullOrWhiteSpace(username))
        {
            _statusMessage = "Enter a username to create an account.";
            _isBusy = false;
            return;
        }

        if (string.IsNullOrWhiteSpace(password))
        {
            _statusMessage = "Enter a password to create an account.";
            _isBusy = false;
            return;
        }

        if (_turnstileEnabled && string.IsNullOrWhiteSpace(_registerTurnstileToken))
        {
            _statusMessage = "Complete the CAPTCHA to continue.";
            _isBusy = false;
            return;
        }

        var result = await Api.RegisterAsync(username, password, _registerTurnstileToken);
        _statusMessage = result.Success ? "Registration successful." : result.Error ?? "Registration failed.";
        if (result.Success)
        {
            _loginUsername = _registerUsername ?? string.Empty;
            _registerUsername = string.Empty;
            _registerPassword = string.Empty;
        }
        if (_turnstileEnabled)
        {
            _registerTurnstileToken = null;
            await ResetTurnstileAsync(RegisterTurnstileElementId);
        }
        _isBusy = false;
    }

    private string GameStatusHint => _gameOver
        ? "Game over – press Space to retry"
        : _gamePaused
            ? "Paused"
            : _ballReady
                ? "Press ↑ or W to launch"
                : "Destroy every brick!";

    private void TogglePanel(AuthPanel panel)
    {
        switch (panel)
        {
            case AuthPanel.Login:
                _showLoginPanel = !_showLoginPanel;
                if (_showLoginPanel)
                {
                    _showRegisterPanel = false;
                }
                break;
            case AuthPanel.Register:
                _showRegisterPanel = !_showRegisterPanel;
                if (_showRegisterPanel)
                {
                    _showLoginPanel = false;
                }
                break;
        }
    }

    private Task UpdateGameState(GameStatusSnapshot snapshot)
    {
        _currentScore = snapshot.Score;
        _currentLevel = snapshot.Level;
        _currentLives = snapshot.ActiveBalls;
        _gamePaused = snapshot.IsPaused;
        _gameOver = snapshot.IsGameOver;
        _ballReady = snapshot.BallReady;
        return Task.CompletedTask;
    }

    private void Logout()
    {
        _isLoggedIn = false;
        _currentUser = string.Empty;
        _bestEntry = null;
        _loginTurnstileToken = null;
        _registerTurnstileToken = null;
        if (_turnstileEnabled)
        {
            _turnstileRenderPending = true;
        }
        Api.ClearAuthentication();
        _statusMessage = "Signed out.";
    }

    private async Task RefreshLeaderboardAsync()
    {
        var result = await Api.GetLeaderboardAsync(10);
        if (result.Success && result.Value is not null)
        {
            _leaderboard = result.Value.ToList();
            _isLeaderboardLoading = false;
            _isAccountLoading = false;
        }
        else
        {
            _leaderboard.Clear();
            if (!string.IsNullOrWhiteSpace(result.Error))
            {
                _statusMessage = result.Error;
            }
        }
    }

    private async Task LoadBestAsync()
    {
        if (!_isLoggedIn)
        {
            _bestEntry = null;
            return;
        }

        var result = await Api.GetBestAsync(_currentUser);
        if (result.Success)
        {
            _bestEntry = result.Value;
        }
    }

    private async Task HandleGameFinished(int score)
    {
        if (!_isLoggedIn || string.IsNullOrWhiteSpace(_currentUser))
        {
            _statusMessage = "Score not submitted (not logged in).";
            return;
        }

        var result = await Api.SubmitScoreAsync(_currentUser, score);
        _statusMessage = result.Success ? $"Score {score} submitted." : result.Error ?? "Score submission failed.";
        if (result.Success)
        {
            await RefreshLeaderboardAsync();
            await LoadBestAsync();
        }
    }

    private async Task RenderTurnstileAsync(string elementId, string action)
    {
        if (!_turnstileEnabled || string.IsNullOrWhiteSpace(_turnstileSiteKey) || _turnstileRef is null)
        {
            return;
        }

        try
        {
            await JS.InvokeVoidAsync("turnstileInterop.render", elementId, _turnstileSiteKey, _turnstileRef, nameof(HandleTurnstileTokenAsync), action);
        }
        catch
        {
            // If the widget fails to render, keep the app functional without CAPTCHA.
            _turnstileEnabled = false;
        }
    }

    private async Task ResetTurnstileAsync(string elementId)
    {
        if (!_turnstileEnabled)
        {
            return;
        }

        await JS.InvokeVoidAsync("turnstileInterop.reset", elementId);
    }

    private async Task ResetAllTurnstilesAsync()
    {
        if (!_turnstileEnabled)
        {
            return;
        }

        _loginTurnstileToken = null;
        _registerTurnstileToken = null;
        await ResetTurnstileAsync(LoginTurnstileElementId);
        await ResetTurnstileAsync(RegisterTurnstileElementId);
    }

    [JSInvokable]
    public Task HandleTurnstileTokenAsync(string elementId, string? token)
    {
        var normalized = string.IsNullOrWhiteSpace(token) ? null : token;
        if (elementId == LoginTurnstileElementId)
        {
            _loginTurnstileToken = normalized;
        }
        else if (elementId == RegisterTurnstileElementId)
        {
            _registerTurnstileToken = normalized;
        }

        return Task.CompletedTask;
    }

    public void Dispose()
    {
        _turnstileRef?.Dispose();
    }
}
